name: Process Signups
on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  issues: write

jobs:
  add_signup:
    if: |
      contains(join(github.event.issue.labels.*.name, ','), 'signup')
    runs-on: ubuntu-latest
    steps:
      - name: Handle signup via github-script
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const author = issue.user.login;
            const number = issue.number;

            // Parse Project ID from body ("Project ID: proj-001")
            const body = issue.body || "";
            const match = body.match(/Project ID:\s*([A-Za-z0-9._-]+)/i);
            if (!match) {
              await github.rest.issues.createComment({
                ...context.repo, issue_number: number,
                body: "❌ Could not find **Project ID** in the issue body. Please ensure the dashboard link pre-filled it."
              });
              return;
            }
            const projectId = match[1];

            // Load projects.json
            const path = "data/projects.json";
            const fileRes = await github.rest.repos.getContent({
              ...context.repo, path
            });
            const sha = fileRes.data.sha;
            const content = Buffer.from(fileRes.data.content, 'base64').toString('utf8');
            let projects = JSON.parse(content);
            const idx = projects.findIndex(p => p.id === projectId);

            if (idx === -1) {
              await github.rest.issues.createComment({
                ...context.repo, issue_number: number,
                body: `❌ Project with ID **${projectId}** not found.`
              });
              return;
            }

            const proj = projects[idx];
            proj.signups = Array.isArray(proj.signups) ? proj.signups : [];
            if (!proj.signups.includes(author)) {
              proj.signups.push(author);
            } else {
              await github.rest.issues.createComment({
                ...context.repo, issue_number: number,
                body: `ℹ️ @${author} is already signed up for **${proj.title}**.`
              });
            }

            // Commit update
            const newContent = Buffer.from(JSON.stringify(projects, null, 2)).toString('base64');
            await github.rest.repos.createOrUpdateFileContents({
              ...context.repo,
              path,
              message: `chore(signup): add @${author} to ${projectId} via #${number}`,
              content: newContent,
              sha
            });

            await github.rest.issues.createComment({
              ...context.repo, issue_number: number,
              body: `✅ Added @${author} to signups for **${proj.title}** (ID: \`${projectId}\`).`
            });

            // Close the issue
            await github.rest.issues.update({
              ...context.repo, issue_number: number, state: "closed"
            });
``
